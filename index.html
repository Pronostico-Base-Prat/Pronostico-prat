<script>
    // Usamos el enlace directo pero con un par√°metro para forzar la descarga limpia
    const URL_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQrxJhBvpk3JZuOMWpKPZ2PMi2DYFEjxhSTWMbx4i_EHHI6rh9frJuskRuaX-OXJqc_Akz6Dh5qLr72/pub?output=csv";

    async function actualizarDatos() {
        const dashboard = document.getElementById('dashboard');
        const footer = document.getElementById('footer-status');

        try {
            // El truco est√° en pedirlo como texto plano y limpiar caracteres de control
            const response = await fetch(URL_BASE + "&t=" + Date.now());
            let rawData = await response.text();
            
            // Si Google manda su script de error, lo detectamos aqu√≠
            if (rawData.includes("google-base-scripts") || rawData.includes("<script")) {
                footer.innerHTML = "‚ö†Ô∏è Google est√° demorando la entrega. Reintentando en 10 segundos...";
                setTimeout(actualizarDatos, 10000);
                return;
            }

            // Procesamos las filas ignorando comas internas (especial para tu planilla)
            const filas = rawData.split(/\r?\n/).map(line => {
                const res = []; let curr = ''; let q = false;
                for (let c of line) {
                    if (c === '"') q = !q;
                    else if (c === ',' && !q) { res.push(curr.trim()); curr = ''; }
                    else curr += c;
                }
                res.push(curr.trim());
                return res;
            }).filter(f => f.length >= 8 && f[0] !== "" && !f[0].includes("function"));

            if (filas.length <= 1) {
                footer.innerHTML = "‚è≥ Esperando que Google Sheets libere los datos...";
                return;
            }

            dashboard.innerHTML = "";
            let diaActual = "";
            let gridActual = null;

            // Saltamos la fila de encabezado (i=1)
            for (let i = 1; i < filas.length; i++) {
                const col = filas[i];
                if (!col[0]) continue;

                if (col[0] !== diaActual) {
                    diaActual = col[0];
                    const seccion = document.createElement('div');
                    seccion.className = 'seccion-dia';
                    seccion.innerHTML = `<div class="titulo-dia">üìÖ ${diaActual}</div>`;
                    gridActual = document.createElement('div');
                    gridActual.className = 'grid-tarjetas';
                    seccion.appendChild(gridActual);
                    dashboard.appendChild(seccion);
                }

                gridActual.innerHTML += `
                    <div class="card">
                        <div class="card-header">
                            <h3>üïí ${col[1]}</h3>
                            <span class="badge-riesgo">${col[8] || 'Bajo'}</span>
                        </div>
                        <div class="fila-dato"><span class="label">‚òÅÔ∏è Nubes</span><span class="valor">${col[2]}</span></div>
                        <div class="fila-dato"><span class="label">üëÅÔ∏è Visib.</span><span class="valor">${col[3]}</span></div>
                        <div class="fila-dato"><span class="label">üå¨Ô∏è Viento</span><span class="valor">${col[4]}</span></div>
                        <div class="fila-dato"><span class="label">üåä Mar</span><span class="valor">${col[5]}</span></div>
                        <div class="bloque-temp">
                            <div class="temp-item"><span class="temp-val">${col[6].replace(/"/g, '')}</span><span class="temp-lbl">T¬∞ Aire</span></div>
                            <div class="temp-item"><span class="temp-val">${col[7].replace(/"/g, '')}</span><span class="temp-lbl">S. T√©rmica</span></div>
                        </div>
                    </div>`;
            }
            footer.innerHTML = `‚úÖ Datos actualizados: ${new Date().toLocaleTimeString()}`;

        } catch (e) {
            console.error(e);
            footer.innerHTML = "‚ùå Error de conexi√≥n con la planilla.";
        }
    }

    actualizarDatos();
    setInterval(actualizarDatos, 300000); // 5 minutos
</script>
