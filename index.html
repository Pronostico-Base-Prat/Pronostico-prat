<script>
    const SHEET_ID = '186HJEbrDHelhKLu0jRCfXNX3XIVJpHfvkepO5Zm6MI';
    // Accedemos espec√≠ficamente a la "Hoja 1"
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Hoja%201`;

    async function cargarClima() {
        const dash = document.getElementById('dashboard');
        const stat = document.getElementById('status');

        try {
            const resp = await fetch(URL + "&v=" + Date.now());
            const text = await resp.text();
            
            // Esto extrae los datos puros del JSON de Google
            const jsonData = JSON.parse(text.substring(47, text.length - 2));
            const rows = jsonData.table.rows;

            if (!rows || rows.length <= 1) {
                stat.innerHTML = "‚è≥ Esperando datos v√°lidos de la planilla...";
                return;
            }

            dash.innerHTML = "";
            let diaActual = "";
            let gridActual = null;

            rows.forEach((r, index) => {
                if (index === 0) return; // Saltamos la fila de t√≠tulos (D√≠a, Tramo, etc.)
                
                const col = r.c.map(cell => cell ? (cell.f || cell.v) : "");
                if (!col[0]) return;

                if (col[0] !== diaActual) {
                    diaActual = col[0];
                    const divDia = document.createElement('div');
                    divDia.className = 'dia-grupo';
                    divDia.innerHTML = `<div class="dia-titulo">üìÖ ${diaActual}</div>`;
                    gridActual = document.createElement('div');
                    gridActual.className = 'grid';
                    divDia.appendChild(gridActual);
                    dash.appendChild(divDia);
                }

                gridActual.innerHTML += `
                    <div class="card">
                        <h3>üïí ${col[1]}</h3>
                        <div class="dato"><span class="label">‚òÅÔ∏è Nubes</span><span class="val">${col[2]}</span></div>
                        <div class="dato"><span class="label">üëÅÔ∏è Visib.</span><span class="val">${col[3]}</span></div>
                        <div class="dato"><span class="label">üå¨Ô∏è Viento</span><span class="val">${col[4]}</span></div>
                        <div class="dato"><span class="label">üåä Mar</span><span class="val">${col[5]}</span></div>
                        <div class="temps">
                            <div style="text-align:center"><span class="t-val">${col[6]}</span><span class="t-lbl">T¬∞ Aire</span></div>
                            <div style="text-align:center"><span class="t-val">${col[7]}</span><span class="t-lbl">S. T√©rmica</span></div>
                        </div>
                    </div>`;
            });

            stat.innerHTML = `‚úÖ Actualizado: ${new Date().toLocaleTimeString()}`;

        } catch (e) {
            console.error("Error:", e);
            stat.innerHTML = "‚ö†Ô∏è Error de conexi√≥n. Revisa que el bot√≥n 'Compartir' est√© en 'Cualquier persona con el enlace'.";
        }
    }

    cargarClima();
    setInterval(cargarClima, 300000); 
</script>
