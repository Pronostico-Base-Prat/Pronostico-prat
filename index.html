<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteo Prat | Oficial</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0a2540; --blue: #004e92; --green: #2ecc71; --bg: #f0f2f5; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        header { background: linear-gradient(135deg, var(--navy), var(--blue)); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; }
        #dashboard { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .dia-grupo { margin-bottom: 30px; }
        .dia-titulo { background: var(--navy); color: white; padding: 10px 20px; border-radius: 5px; display: inline-block; margin-bottom: 15px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 10px; padding: 15px; border-left: 6px solid var(--green); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; color: var(--navy); font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .dato { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; border-bottom: 1px solid #f9f9f9; }
        .label { color: #666; } .val { font-weight: bold; color: #222; }
        .temps { background: #f8f9fa; border-radius: 6px; padding: 10px; margin-top: 10px; display: flex; justify-content: space-around; text-align: center; }
        .t-val { font-size: 1rem; font-weight: bold; color: var(--blue); display: block; }
        .t-lbl { font-size: 0.65rem; color: #888; }
        #status { text-align: center; padding: 20px; color: #666; font-size: 0.8rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h1>Base Naval Ant√°rtica "Capit√°n Arturo Prat"</h1>
    <p>Pron√≥stico Meteorol√≥gico Oficial</p>
</header>

<div id="dashboard">
    <div class="loader" id="loader"></div>
</div>
<div id="status">Conectando con la base...</div>

<script>
    // USAMOS EL MODO EXPORT PARA EVITAR SCRIPTS DE BLOQUEO
    const SHEET_ID = "1vQrxJhBvpk3JZuOMWpKPZ2PMi2DYFEjxhSTWMbx4i_EHHI6rh9frJuskRuaX-OXJqc_Akz6Dh5qLr72";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

    async function init() {
        const dash = document.getElementById('dashboard');
        const stat = document.getElementById('status');
        
        try {
            const response = await fetch(CSV_URL + "&cache=" + Date.now());
            const text = await response.text();

            // Si Google manda c√≥digo raro, lo detectamos
            if (text.includes("<!DOCTYPE") || text.includes("function n(a)")) {
                stat.innerHTML = "‚è≥ Google est√° verificando la conexi√≥n... Reintentando autom√°ticamente.";
                setTimeout(init, 5000);
                return;
            }

            // Procesamos filas (separaci√≥n inteligente por comas)
            const rows = text.split(/\r?\n/).map(line => {
                const parts = []; let cell = ''; let inQ = false;
                for (let char of line) {
                    if (char === '"') inQ = !inQ;
                    else if (char === ',' && !inQ) { parts.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                parts.push(cell.trim());
                return parts;
            }).filter(r => r.length >= 8 && (r[0].toLowerCase().includes("lunes") || r[0].toLowerCase().includes("martes") || r[0].toLowerCase().includes("mi√©rcoles") || r[0].toLowerCase().includes("jueves") || r[0].toLowerCase().includes("viernes") || r[0].toLowerCase().includes("s√°bado") || r[0].toLowerCase().includes("domingo")));

            if (rows.length === 0) {
                stat.innerHTML = "‚ö†Ô∏è No hay datos disponibles en la planilla actualmente.";
                document.getElementById('loader').style.display = 'none';
                return;
            }

            dash.innerHTML = "";
            let currentDay = "";
            let currentGrid = null;

            rows.forEach(row => {
                if (row[0] !== currentDay) {
                    currentDay = row[0];
                    const container = document.createElement('div');
                    container.className = 'dia-grupo';
                    container.innerHTML = `<div class="dia-titulo">üìÖ ${currentDay}</div>`;
                    currentGrid = document.createElement('div');
                    currentGrid.className = 'grid';
                    container.appendChild(currentGrid);
                    dash.appendChild(container);
                }

                currentGrid.innerHTML += `
                    <div class="card">
                        <h3>üïí ${row[1]}</h3>
                        <div class="dato"><span class="label">‚òÅÔ∏è Nubosidad</span><span class="val">${row[2]}</span></div>
                        <div class="dato"><span class="label">üëÅÔ∏è Visibilidad</span><span class="val">${row[3]}</span></div>
                        <div class="dato"><span class="label">üå¨Ô∏è Viento</span><span class="val">${row[4]}</span></div>
                        <div class="dato"><span class="label">üåä Mar</span><span class="val">${row[5]}</span></div>
                        <div class="temps">
                            <div class="t-item"><span class="t-val">${row[6].replace(/"/g,'')}</span><span class="t-lbl">T¬∞ Aire</span></div>
                            <div class="t-item"><span class="t-val">${row[7].replace(/"/g,'')}</span><span class="t-lbl">S. T√©rmica</span></div>
                        </div>
                    </div>`;
            });

            stat.innerHTML = `‚úÖ Actualizado: ${new Date().toLocaleTimeString()}`;

        } catch (e) {
            stat.innerHTML = "‚ùå Error de red. Reintentando...";
            setTimeout(init, 10000);
        }
    }

    init();
    setInterval(init, 300000); // 5 min refresh
</script>
</body>
</html>
